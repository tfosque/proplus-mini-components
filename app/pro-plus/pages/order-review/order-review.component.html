<div class="loading-container" *ngIf="loading">
    <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
</div>
<!-- validation that the shopping cart has items -->
<ng-template mat-tab-label> &#10124; Review </ng-template>
<h1>
    <mat-icon style="margin-right: 10px; font-size: 30px">verified</mat-icon
    >Order Review
</h1>

<div *ngIf="cart && cart.value.items.length">
    <div class="grid-x grid-margin-x">
        <div style="padding-right: 10px" class="cell large-9">
            <div>
                <p style="font-weight: bolder">
                    *** Tax, shipping and handling will be calculated at final
                    order processing. ***
                </p>
            </div>
            <mat-divider class="divider"></mat-divider>

            <ng-container *ngIf="orderReviewStore.getState() | async as review">
                <div>
                    <!-- <app-dump-grid [input]="review.request"></app-dump-grid> -->

                    <!-- <app-dump-grid [input]="currentOrderReview"></app-dump-grid> -->

                    <!-- Errors -->
                    <!-- <div class="callout alert" *ngIf="!review.canPlaceOrder">
                        <p>Please do the following before placing an order:</p>
                        <ul>
                            <li *ngFor="let error of review.errors">
                                {{ error.error }}
                                <ul *ngIf="error.subError">
                                    <li>{{ error.subError }}</li>
                                </ul>
                            </li>
                        </ul>
                    </div> -->

                    <!-- Heading -->
                    <div class="grid-x">
                        <div
                            class="cell title"
                            style="
                                border: solid thin #e8e8e8;
                                padding: 10px 15px;
                                color: #025f9e;
                            "
                        >
                            <span *ngIf="review.shippingMethod === 'Pick_up'"
                                >PREFERED PICKUP</span
                            >
                            <span *ngIf="review.shippingMethod === 'Ship_to'"
                                >DELIVERY</span
                            >
                            <span> DATE AND TIME</span>
                        </div>

                        <!-- Date: / Left Side-->
                        <div
                            class="cell medium-6"
                            style="
                                padding: 12px 15px;
                                border: solid thin #e8e8e8;
                                border-top: none;
                                font-size: 14px;
                            "
                        >
                            <!-- Delivery Options -->
                            <div class="field" style="padding: 9px 0px">
                                <div class="btn-container">
                                    <b>Delivery Option:</b>
                                    <button
                                        mat-stroked-button
                                        color="secondary"
                                        style="float: right"
                                        (click)="goBack()"
                                    >
                                        Edit
                                    </button>
                                </div>
                                <div *ngIf="review.deliveryOption === 'onHold'">
                                    Place Order On Hold
                                </div>
                                <ng-container
                                    *ngIf="
                                        review.deliveryOption === 'scheduled'
                                    "
                                    style="padding: 0px 0px"
                                >
                                    <!-- <span>Schedule </span> -->
                                    <div>
                                        <span>Scheduled &mdash; </span>
                                        <span>{{
                                            review.deliveryDate
                                        }}</span>
                                        <span> at </span>
                                        <span>{{
                                            review.deliveryTime | formatTime
                                        }}</span>
                                    </div>
                                </ng-container>
                            </div>

                            <!-- Delivery Method -->
                            <div class="field" style="padding: 9px 0px">
                                <div class="btn-container">
                                    <b>Delivery Method:</b>
                                    <button
                                        mat-stroked-button
                                        color="secondary"
                                        style="float: right"
                                        (click)="goBack()"
                                    >
                                        Edit
                                    </button>
                                </div>
                                <div
                                    *ngIf="review.shippingMethod === 'Pick_up'"
                                >
                                    Pick Up
                                </div>
                                <div
                                    *ngIf="review.shippingMethod === 'Ship_to'"
                                >
                                    Ship to Address
                                </div>
                            </div>

                            <!-- Shipping/Pickup Address -->
                            <div
                                *ngIf="review.shippingAddress as sa"
                                style="padding: 9px 0px"
                            >
                                <div
                                    class="btn-container"
                                    style="font-weight: bold"
                                >
                                    <span
                                        *ngIf="
                                            review.shippingMethod === 'Pick_up'
                                        "
                                        ><b>Pickup Address:</b></span
                                    >
                                    <span
                                        *ngIf="
                                            review.shippingMethod === 'Ship_to'
                                        "
                                        ><b>Shipping Address:</b></span
                                    >
                                    <button
                                        mat-stroked-button
                                        color="secondary"
                                        style="float: right"
                                        (click)="goBack()"
                                    >
                                        Edit
                                    </button>
                                </div>
                                <div *ngIf="sa.branchName">
                                    {{ sa.branchName }}
                                </div>
                                <div *ngIf="sa.nickName">{{ sa.nickName }}</div>
                                <div *ngIf="sa.firstName || sa.lastName">
                                    {{ sa.firstName }} {{ sa.lastName }}
                                </div>
                                <div>{{ sa.address1 }}</div>
                                <div *ngIf="sa.address2">{{ sa.address2 }}</div>
                                <div *ngIf="sa.address3">{{ sa.address3 }}</div>
                                <div>
                                    {{ sa.city }} {{ sa.state }}
                                    {{ sa.postalCode }}
                                </div>
                                <div *ngIf="sa.countryValue">
                                    {{ sa.countryValue }}
                                </div>
                                <div>Phone Number: {{ (review.contactInfo && review.contactInfo.phoneNumber) || sa.phoneNumber}}</div>
                            </div>

                            <div
                                class="field"
                                style="padding: 9px 0px"
                                *ngIf="review.instructions"
                            >
                                <div>
                                    <b>Special Instructions:</b>
                                    <button
                                        mat-stroked-button
                                        color="secondary"
                                        style="float: right"
                                        (click)="goBack()"
                                    >
                                        Edit
                                    </button>
                                </div>
                                <div>{{ review.instructions }}</div>
                            </div>
                        </div>

                        <!--Time: Right Side -->
                        <div
                            class="cell medium-6"
                            style="
                                padding: 12px 15px;
                                border: solid thin #e8e8e8;
                                border-top: none;
                                border-left: none;
                                font-size: 14px;
                            "
                        >
                            <div style="padding: 9px 0px">
                                <mat-form-field
                                    class="formInput"
                                    floatLabel="auto"
                                >
                                <mat-label *ngIf="!review.jobNameRequired">PO or Job name</mat-label>
                                <mat-label *ngIf="review.jobNameRequired">PO Name</mat-label>
                                    <input
                                        maxlength="20"
                                        matInput
                                        [value]="review.PO"
                                        name="PO"
                                        [errorStateMatcher]="matcher"
                                        [formControl]="poFormControl"
                                        [required]="review.poRequired"
                                        (input)="
                                            orderReviewStore.dispatch.setPO(
                                                $event.target.value
                                            )
                                        "
                                    />
                                    <mat-error class="mat-error" *ngIf="poFormControl.hasError('required')"
                                        >PO is required</mat-error
                                    >
                                </mat-form-field>
                            </div>

                            <div
                                style="padding: 9px 0px; padding-top: 15px;"
                                *ngIf="review.showJobNumber"
                            >
                                <!-- <b>Job:</b>&nbsp; -->
                                <mat-form-field
                                    class="formInput"
                                    floatLabel="auto"
                                >
                                    <mat-label>Job Account</mat-label>
                                    <mat-select
                                        [ngModel]="review.selectedJob"
                                        [formControl]="jobFormControl"
                                        name="job"
                                        [required]="review.jobNumberRequired"
                                        (selectionChange)="
                                            selectJob($event.value)
                                        "
                                    >
                                        <mat-option [value]="''">Select Job Account</mat-option>
                                        <mat-option
                                            *ngFor="let job of review.jobs"
                                            [value]="job"
                                        >
                                            {{ job.jobName }}
                                        </mat-option>
                                    </mat-select>
                                    <mat-error class="mat-error" *ngIf="jobFormControl.hasError('required')"
                                        >Job account is required</mat-error
                                    >
                                </mat-form-field>
                            </div>

                            <div *ngIf="review.jobNameRequired">
                                <mat-form-field
                                    class="formInput"
                                    floatLabel="auto"
                                >
                                    <mat-label>Job Name</mat-label>
                                    <input
                                        maxlength="15"
                                        matInput
                                        [value]="review.jobName"
                                        [formControl]="jobNameFormControl"
                                        name="JobName"
                                        [errorStateMatcher]="matcher"
                                        [required]="review.jobNameRequired"
                                        (input)="
                                            orderReviewStore.dispatch.setJobName(
                                                $event.target.value
                                            )
                                        "
                                    />
                                    <mat-error class="mat-error" *ngIf="jobFormControl.hasError('required')"
                                        >Job name is required</mat-error
                                    >
                                </mat-form-field>
                            </div>
                            <div class="grid-x">
                                <div class="upload-file-btn cell medium-12 small-12">
                                    <input
                                        style="display: none" 
                                        multiple
                                        (change)="onFileSelect($event)"
                                        value=""
                                        type="file"
                                        accept=".jpg, .jpeg, .pdf, .xls, .xlsx, .png"
                                        #fileSelect
                                        />
                                    <button  
                                        mat-raised-button
                                        (click)="fileSelect.click()"
                                        matTooltip="Select a file"
                                        [matTooltipPosition]="'above'"
                                        style="padding: 0 5px"
                                    >
                                        <mat-icon style="font-size: 20px; font-weight: 100;">upload_file</mat-icon> <span style="font-size: 12px;">Upload Related Documents</span>
                                    </button>
                                </div>
                                <div class="upload-info-text cell medium-12 small-12">
                                    <span matTooltipPosition="left"
                                        matTooltip="We accept the following formats: .jpg, .pdf, .xls for files up to 5MB"
                                        matTooltipClass="custom-tooltip"
                                        style="font-size: 0.8rem;"
                                    >
                                        We accept the following formats: .jpg, .pdf, .xls for files up to 5MB
                                    </span>
                                </div>
                            </div>
                            <div class="files-list">
                                <div class="single-file" *ngFor="let file of uploadedFiles; let i = index">
                                    <div class="info">
                                        <h4 class="name">
                                            <a class="name-link" href="javascript:void(0);"  (click)="downloadOrderDocument(file)"> {{ file }} </a> 
                                        </h4>
                                    </div>
                                    <div class="delete">
                                        <a  href="javascript:void(0);" (click)="deleteUploadFile(file)">
                                            <mat-icon color="emphasis">delete</mat-icon>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <!-- Email Confirmation -->
                            <div style="padding: 9px 0px">
                                <div>
                                    <b>Email Confirmation Recipients</b>
                                </div>
                                <div
                                    *ngFor="
                                        let email of review.additionalRecipients;
                                        let i = index
                                    "
                                    style="margin-top: 10px"
                                    class="col-sm-3"
                                >
                                    <div class="form-group">
                                        <mat-form-field
                                            class="form-email"
                                            floatLabel="auto"
                                        >
                                            <mat-label>E-mail</mat-label>
                                            <input
                                                matInput
                                                [(ngModel)]="
                                                    review.additionalRecipients[
                                                        i
                                                    ].email
                                                "
                                                name="name{{ i }}"
                                            />
                                        </mat-form-field>

                                        <a
                                            color="warning"
                                            (click)="deleteInput(i)"
                                        >
                                            <mat-icon>delete</mat-icon>
                                        </a>
                                    </div>
                                </div>
                                <div *ngIf="review.additionalRecipients.length < 3">
                                    <a color="primary" (click)="add()"
                                        >Add Recipient</a
                                    >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <!-- Items -->
                    <ng-container *ngIf="cart?.value?.items as items">
                        <table
                            mat-table
                            [dataSource]="items"
                            matSort
                            class="full-width padded-table"
                        >
                            <ng-container matColumnDef="product">
                                <th mat-header-cell *matHeaderCellDef>
                                    Product
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div>
                                        <img
                                            [src]="element.productImageUrl | errorImage"
                                            appImagePreload
                                            [default]="element.productOnErrorImageUrl | errorImage: '/assets/images/image-not-available.svg'"
                                            width="80"
                                            height="80"
                                        />
                                    </div>
                                    <div class="hide-for-medium">
                                        <strong>Item #:</strong>
                                        <span>{{ element.catalogRefId }}</span>
                                    </div>
                                </td>
                                <td mat-footer-cell *matFooterCellDef></td>
                            </ng-container>
                            <ng-container matColumnDef="details">
                                <th mat-header-cell *matHeaderCellDef>
                                    Details
                                </th>
                                <td mat-cell *matCellDef="let element">
                                    <div
                                        [innerHTML]="
                                            element.itemOrProductDescription
                                        "
                                    ></div>
                                    <div class="show-for-medium">
                                        <div><strong>Item #:</strong></div>
                                        <div>{{ element.catalogRefId }}</div>
                                    </div>
                                    <div class="hide-for-medium">
                                        <div class="grid-x">
                                            <div class="cell small-4">
                                                {{
                                                    element.unitPrice
                                                        | price: element.uom
                                                }}
                                            </div>
                                            <div
                                                class="cell small-4"
                                                style="text-align: center"
                                            >
                                                {{ element.quantity }}
                                            </div>
                                            <div
                                                class="cell small-4"
                                                style="text-align: right"
                                            >
                                                <strong>{{
                                                    element.unitPrice *
                                                        element.quantity
                                                        | totalPrice
                                                        | currency
                                                }}</strong>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td mat-footer-cell *matFooterCellDef>
                                    <strong>Sub-Total</strong>
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="price">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    class="show-for-medium"
                                >
                                    Price
                                </th>
                                <td
                                    mat-cell
                                    *matCellDef="let element"
                                    class="show-for-medium"
                                >
                                    <strong>
                                        <span>{{
                                            element.unitPrice
                                                | price: element.uom
                                        }}</span>
                                    </strong>
                                </td>
                                <td
                                    mat-footer-cell
                                    *matFooterCellDef
                                    class="show-for-medium"
                                >
                                    &nbsp;
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="qty">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    class="show-for-medium"
                                >
                                    Qty
                                </th>
                                <td
                                    mat-cell
                                    *matCellDef="let element"
                                    class="show-for-medium"
                                >
                                    {{ element.quantity }}
                                </td>
                                <td
                                    mat-footer-cell
                                    *matFooterCellDef
                                    class="show-for-medium"
                                >
                                    &nbsp;
                                </td>
                            </ng-container>
                            <ng-container matColumnDef="total">
                                <th
                                    mat-header-cell
                                    *matHeaderCellDef
                                    class="show-for-medium"
                                >
                                    Total
                                </th>
                                <td
                                    mat-cell
                                    *matCellDef="let element"
                                    class="show-for-medium"
                                >
                                    <span>{{
                                        element.unitPrice * element.quantity
                                            | totalPrice
                                            | currency
                                    }}</span>
                                </td>
                            </ng-container>
                            <tr
                                mat-header-row
                                *matHeaderRowDef="displayedColumns2"
                            ></tr>
                            <tr
                                mat-row
                                *matRowDef="let row; columns: displayedColumns2"
                            ></tr>
                        </table>
                    </ng-container>
                </div>
                <div class="show-for-medium">
                    <div class="flexContainerButton">
                        <p>
                            <button
                                color="secondary"
                                mat-raised-button
                                type="button"
                                (click)="goBack()"
                                [ngClass]="{ 'back-btn': userPermPlaceOrder }"
                            >
                                <mat-icon>navigate_before</mat-icon>
                                <span>Back</span>
                            </button>
                            <button
                                [color]="isAccountClosed ? 'disabled' : 'secondary'"
                                mat-raised-button
                                type="button"
                                (click)="openDialogSaveOrder()"
                                [disabled]="isAccountClosed"
                                [hidden]="!userPermPlaceOrder"
                            >
                                <span>Save Order</span>
                            </button>
                        </p>
                        <div *ngIf="this.userPermValueApprove">
                            <p>
                                <button
                                    color="{{
                                        review.canPlaceOrder
                                            ? 'emphasis'
                                            : 'disable'
                                    }}"
                                    [disabled]="!review.canPlaceOrder"
                                    mat-raised-button
                                    (click)="placeOrder()"
                                    class="cell"
                                >
                                    <span *ngIf="approverForOrder"
                                        >Approve & Place Order</span
                                    >
                                    <span *ngIf="!approverForOrder"
                                        >Place Order</span
                                    >
                                    <mat-icon>done</mat-icon>
                                </button>
                            </p>
                        </div>
                        <div *ngIf="!this.userPermValueApprove">
                            <p>
                                <button
                                    color="{{
                                        review.canPlaceOrder
                                            ? 'primary'
                                            : 'disable'
                                    }}"
                                    [disabled]="!review.canPlaceOrder"
                                    mat-raised-button
                                    class="cell"
                                    [matMenuTriggerFor]="menu"
                                >
                                    <span>Submit For Approval</span>
                                    <mat-icon>keyboard_arrow_down</mat-icon>
                                </button>
                                <mat-menu #menu="matMenu" direction="down">
                                    <button
                                        mat-menu-item
                                        (click)="openDialogueApprove(approver)"
                                        *ngFor="
                                            let approver of approvers
                                        "
                                    >
                                        {{ approver.email }}
                                    </button>
                                </mat-menu>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="show-for-small-only">
                    <div class="flexContainerButton">
                        <p>
                            <button
                                color="secondary"
                                mat-raised-button
                                type="button"
                                (click)="goBack()"
                            >
                                <mat-icon>navigate_before</mat-icon>
                                <span>Back</span>
                            </button>
                        </p>
                        <div *ngIf="this.userPermValueApprove">
                            <p>
                                <button
                                    color="{{
                                        review.canPlaceOrder
                                            ? 'emphasis'
                                            : 'disable'
                                    }}"
                                    [disabled]="!review.canPlaceOrder"
                                    mat-raised-button
                                    (click)="placeOrder()"
                                    class="cell"
                                >
                                    <span *ngIf="approverForOrder"
                                        >Approve & Place Order</span
                                    >
                                    <span *ngIf="!approverForOrder"
                                        >Place Order</span
                                    >
                                    <mat-icon>done</mat-icon>
                                </button>
                            </p>
                        </div>
                        <div *ngIf="!this.userPermValueApprove">
                            <p>
                                <button
                                    color="{{
                                        review.canPlaceOrder
                                            ? 'primary'
                                            : 'disable'
                                    }}"
                                    [disabled]="!review.canPlaceOrder"
                                    mat-raised-button
                                    class="cell"
                                    [matMenuTriggerFor]="menu"
                                >
                                    <span>Submit For Approval</span>
                                    <mat-icon>keyboard_arrow_down</mat-icon>
                                </button>
                                <mat-menu #menu="matMenu" direction="down">
                                    <button
                                        mat-menu-item
                                        (click)="openDialogueApprove(approver)"
                                        *ngFor="
                                            let approver of approvers
                                        "
                                    >
                                        {{ approver.email }}
                                    </button>
                                </mat-menu>
                            </p>
                        </div>
                    </div>
                    <div class="flexContainerButton">
                        <button
                            [color]="isAccountClosed ? 'disabled' : 'secondary'"
                            mat-raised-button
                            type="button"
                            (click)="openDialogSaveOrder()"
                            [disabled]="isAccountClosed"
                            [hidden]="!userPermPlaceOrder"
                        >
                            <span>Save Order</span>
                        </button>
                    </div>
                </div>
                <!-- <app-dump-grid [input]="review"></app-dump-grid> -->
            </ng-container>

            <!-- <div style="clear: both;"></div> -->
        </div>
        <div style="vertical-align: top" class="cell large-3">
            <div class="grid-x align-right">
                <ng-container *ngIf="cart | async as c">
                    <div
                        class="cell"
                        *ngIf="
                            c.summary && c.summary.total != 0;
                            else TotalZero
                        "
                    >
                        <table
                            class="summary-table"
                            *ngIf="
                                c.summary && !c.summary.displayTotalMsg;
                                else TotalZeroFirst
                            "
                        >
                            <tr>
                                <th colspan="2" class="summary-header">
                                    <h3>Order Summary</h3>
                                </th>
                            </tr>
                            <tr>
                                <td class="summary-text-default">Sub Total</td>
                                <td class="summary-text-right-default-number">
                                    {{ c.summary.itemsTotal | currency }}
                                </td>
                            </tr>
                            <tr>
                                <td
                                    class="summary-text-default"
                                    style="white-space: nowrap"
                                >
                                    Other Charges
                                    <button
                                        class="icon"
                                        matTooltipPosition="left"
                                        matTooltip="What is Other Charges?
                      Other charges are typically delivery fees, but may include handling and fuel fees."
                                        matTooltipClass="custom-tooltip"
                                    >
                                        <mat-icon>info</mat-icon>
                                    </button>
                                </td>
                                <td [class]="otherCharges.cssClass">
                                    {{ otherCharges.value }}
                                </td>
                            </tr>
                            <tr>
                                <td class="summary-text-default">Tax</td>
                                <td [class]="tax.cssClass">{{ tax.value }}</td>
                            </tr>
                            <tr>
                                <td
                                    class="summary-text-total-default"
                                    colspan="2"
                                >
                                    <div
                                        class="summary-text-total-default-left"
                                    >
                                        Total
                                    </div>
                                    <div [class]="total.cssClass">
                                        {{ total.value }}
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                </ng-container>
                <ng-template #TotalZero>
                    <div class="total" align="right">
                        <div>
                            <h3>Order Summary</h3>
                        </div>
                        <div>
                            <p>Will be calculated at the time of invoicing.</p>
                        </div>
                    </div>
                </ng-template>

                <ng-template #TotalZeroFirst>
                    <table class="summary-table" width="100%">
                        <tr>
                            <td class="summary-header-totalZero">
                                <h3>Order Summary</h3>
                            </td>
                        </tr>
                        <tr>
                            <td style="padding-top: 10px; padding-bottom: 20px">
                                Will be calculated at the time of invoicing.
                            </td>
                        </tr>
                    </table>
                </ng-template>

                <ng-container
                    *ngIf="orderReviewStore.getState() | async as review"
                >
                    <div class="cell" *ngIf="this.userPermValueApprove">
                        <button
                            color="{{
                                review.canPlaceOrder ? 'emphasis' : 'disable'
                            }}"
                            [disabled]="!review.canPlaceOrder"
                            mat-raised-button
                            (click)="placeOrder()"
                            class="cell"
                            [ngClass]="{ 'approver-btn': approverForOrder }"
                        >
                            <span *ngIf="approverForOrder"
                                >Approve & Place Order</span
                            >
                            <span *ngIf="!approverForOrder">Place Order</span>
                            <mat-icon>done</mat-icon>
                        </button>
                    </div>
                    <div class="cell" *ngIf="!this.userPermValueApprove">
                        <button
                            color="{{
                                review.canPlaceOrder ? 'primary' : 'disable'
                            }}"
                            [disabled]="!review.canPlaceOrder"
                            mat-raised-button
                            class="cell"
                            [matMenuTriggerFor]="menu"
                        >
                            <span style="font-size: small"
                                >Submit for Approval</span
                            >
                            <mat-icon>keyboard_arrow_down</mat-icon>
                        </button>
                        <mat-menu #menu="matMenu" direction="down">
                            <button
                                mat-menu-item
                                (click)="openDialogueApprove(approver)"
                                *ngFor="let approver of approvers"
                            >
                                {{ approver.email }}
                            </button>
                        </mat-menu>
                    </div>
                </ng-container>
            </div>
        </div>
    </div>
</div>

<!-- <div>

    <form 
        action="https://dev-static.becn.digital/becn/rest/model/REST/NewRestService/v2/rest/com/becn/uploadOrderRelatedDocuments" 
        method="POST"
        onSubmit="onSubmitForm()"
    >
        {{cart.value.atgOrderId}}
        <input name="orderId" [value]="cart.value.atgOrderId" />
        <input type="file" multiple name="relatedDocuments"  />
        <input type="submit" value="upload" />
    </form>
</div> -->
<!-- <app-dump-grid [input]="orderReviewStore.getState()"></app-dump-grid>
<app-dump-grid [input]="cart"></app-dump-grid> -->
